# 控制一个真实的电机

在现实中使用上一节编写的speed_control控制3508电机

## 创建新的机器人

在src/robot下创建新文件夹，并新建Kconfig文件

## 声明机器人类

    namespace Robot{
    class MotorCtrl {
      ...
    };
    }

### 声明配置文件结构体

`robot.hpp`

  typedef struct {
    Device::BlinkLED::Param led;
    Module::SpeedControl::Param speed_ctrl;
  } Param;

### 声明构造函数

    MotorCtrl(Param& param);

### 其他变量

    Message message_;              /* 订阅发布消息框架 */
    System::Term term_;            /* 命令行 */
    System::Database database_;    /* 数据库 */
    Device::BlinkLED led_;         /* led设备 */
    Device::Can can_;              /* CAN设备 */

    Module::SpeedControl speed_control_;   /* 速度控制模块 */

### 编写配置文件

`robot.cpp`

  Robot::MotorCtrl::Param param = {
    .led = {
      .gpio = BSP_GPIO_LED,
      .timeout = 200,
    },

    .speed_ctrl = {
      .pid = {
        .k = 0.00005f,
        .p = 1.0f,
        .i = 0.0f,
        .d = 0.0f,
        .i_limit = 1.0f,
        .out_limit = 1.0f,
        .d_cutoff_freq = -1.0f,
        .range = -1.0f,
      },

      .motor = {
        .id_feedback = 0x201,
        .id_control = M3508_M2006_CTRL_ID_BASE,
        .model = Device::RMMotor::MOTOR_M3508,
        .can = BSP_CAN_1,
      }
    }
  };

## 编译运行

### Kconfig选择所需开发板和模块

在终端中输入`./project.py config`

选择board-rm-c（即c板），操作系统选择FreeRTOS,机器人选择MotorCtrl，设备选择can、motor、led，模块选择刚刚创建的speed_control.

### 编译下载代码

编译成功之后使用Ozone或者OpenOCD下载固件

### 调试运行

连接电源与电机，设置电机目标速度，测试运行是否正常。

## 注意

* C板can模块需要5V以上供电
