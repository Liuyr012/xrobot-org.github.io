# 在模拟器中控制电机

在webots中模拟一个电机，并使用speed_control进行控制

## 模拟器中创建电机

使用webots创建一个关节节点，添加电机和位置传感器。电机的名称需要和代码中构造电机类时传入的字符串相同，传感器名称为电机名+`_Sensor`。比如本次使用的电机为`motor`，传感器为`motor_Sensor`。

## 创建新的机器人

在src/robot下创建新文件夹，并新建Kconfig文件

    motor_ctrl
    ├── Kconfig
    ├── robot.cpp
    └── robot.hpp

 `robot.hpp`

## 包含头文件

    #include "database.hpp"
    #include "dev_blink_led.hpp"
    #include "speed_control.hpp"
    #include "term.hpp"

## 声明机器人类

    namespace Robot {
    class MotorCtrl {
      ...
    };
    }  // namespace Robot

### 声明配置文件结构体

    typedef struct {
      Device::BlinkLED::Param led;
      Module::SpeedControl::Param speed_ctrl;
    } Param;

### 声明构造函数

    MotorCtrl(Param& param) : led_(param.led), speed_control_(param.speed_ctrl) {}

### 其他变量

    Message message_;           /* 订阅发布消息框架 */
    System::Term term_;         /* 命令行 */
    System::Database database_; /* 数据库 */
    Device::BlinkLED led_;      /* led设备 */

    Module::SpeedControl speed_control_; /* 速度控制模块 */

### 头文件和命名空间

 `robot.cpp`

    #include "robot.hpp"

    using namespace Robot;

### 编写配置文件

    /* clang-format off */
    Robot:: MotorCtrl:: Param param = {
        /* LED引脚和闪烁延时 */
        .led = {
        .gpio = BSP_GPIO_LED,
        .timeout = 200,
        },

        .speed_ctrl = {
        /* PID参数 out=k*(p+i+d) */
        .pid = {
            .k = 0.5f,
            .p = 1.0f,
            .i = 0.0f,
            .d = 0.0f,
            .i_limit = 1.0f,
            .out_limit = 1.0f,
            .d_cutoff_freq = -1.0f,
            .range = -1.0f,
        },

        /* 电机型号 */
        .motor = {
            .model = Device::RMMotor::MOTOR_M3508,
        }
        }
    };
    /* clang-format on */

## 编写robot_init()函数

    void robot_init() {
      auto init_thread_fn = [](void* arg) {
        RM_UNUSED(arg);

        Robot::MotorCtrl motor_ctrl(param);

        while (1) {
          System::Thread::Sleep(UINT32_MAX);
        }
      };

      System::Thread init_thread;

      init_thread.Create(init_thread_fn, (void*)0, "init_thread_fn", 512,
                        System::Thread::Realtime);
    }

## 编译运行

### Kconfig选择所需开发板和模块

在终端中输入 `./project.py config`

选择board-Webots（即c板），操作系统选择Linux-Webots, 机器人选择motor_ctrl，设备选择simulator、blink_led，模块选择刚刚创建的speed_control.

### 编译下载代码

点击下方Build编译成功之后可以直接运行。

### 调试运行

Webots控制器选择`<extern>`，开始仿真。代码运行后仿真会自动启动。

## 注意

* 仿真停止后代码也会停止运行
* `/* clang-format off */`和`/* clang-format on */`是防止中间内容被格式化，方便阅读。

## 完整代码示例

`robot.cpp`

    #include "robot.hpp"

    using namespace Robot;

    /* clang-format off */
    Robot:: MotorCtrl:: Param param = {
        /* LED引脚和闪烁延时 */
        .led = {
        .gpio = BSP_GPIO_LED,
        .timeout = 200,
        },

        .speed_ctrl = {
        /* PID参数 out=k*(p+i+d) */
        .pid = {
            .k = 0.5f,
            .p = 1.0f,
            .i = 0.0f,
            .d = 0.0f,
            .i_limit = 1.0f,
            .out_limit = 1.0f,
            .d_cutoff_freq = -1.0f,
            .range = -1.0f,
        },

        /* 电机型号 */
        .motor = {
            .model = Device::RMMotor::MOTOR_M3508,
        }
        }
    };
    /* clang-format on */

    void robot_init() {
      auto init_thread_fn = [](void* arg) {
        RM_UNUSED(arg);

        Robot::MotorCtrl motor_ctrl(param);

        while (1) {
          System::Thread::Sleep(UINT32_MAX);
        }
      };

      System::Thread init_thread;

      init_thread.Create(init_thread_fn, (void*)0, "init_thread_fn", 512,
                        System::Thread::Realtime);
    }


`robot.hpp`

    #include "database.hpp"
    #include "dev_blink_led.hpp"
    #include "speed_control.hpp"
    #include "term.hpp"

    void robot_init();

    namespace Robot {
    class MotorCtrl {
    public:
      typedef struct {
        Device::BlinkLED::Param led;
        Module::SpeedControl::Param speed_ctrl;
      } Param;

      MotorCtrl(Param& param) : led_(param.led), speed_control_(param.speed_ctrl) {}

      Message message_;           /* 订阅发布消息框架 */
      System::Term term_;         /* 命令行 */
      System::Database database_; /* 数据库 */
      Device::BlinkLED led_;      /* led设备 */

      Module::SpeedControl speed_control_; /* 速度控制模块 */
    };
    }  // namespace Robot

